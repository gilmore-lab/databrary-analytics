# State of the repository

::: {.rmdnote}

**TODO**: Fix paths to data and test rendering.

:::

## Purpose

This document summarizes information about Databrary's holdings, partners, and citations. 
It draws upon datasets specific to these categories that are generated elsewhere.

## Setup

```{r state-of-repo-set-up, include=FALSE}
knitr::opts_chunk$set(message = FALSE, 
                      warning = FALSE)

if (!require("tidyverse")) {
  install.packages("tidyverse")
}
if (!require("kableExtra")) {
  install.packages("kableExtra")
}
if (!require("ggmap")) {
  install.packages("ggmap")
}
if (!require("readr")) {
  install.packages("readr")
}
if (!require("shiny")) {
  install.packages("shiny")
}
if (!require("wordcloud")) {
  install.packages("wordcloud")
}
if (!require("databraryapi")) {
  if (!require("devtools")) {
    install.packages("devtools")
  }
  devtools::install_github("PLAY-behaviorome/databraryapi")
}
if (!require("cowplot")) {
  install.packages("cowplot")
}

library(tidyverse) # for pipe %>% operator

source("R/helpers.R")
```

```{r archive-old, include=FALSE}
copy_to_archive <- function(fpath, fn) {
  if (file.exists(file.path(fpath, fn))) {
    current_fn <- file.path(fpath, fn)
    new_fn <- file.path(fpath, "archive", paste0(Sys.Date(), '_', fn))
    if (file.copy(current_fn, new_fn)) {
      message("Report copied to '", paste0(fpath, "/archive'"))
    }
  } else {
    message("No file copied.")
  }
}

if (params$archive_old) {
  if (!(dir.exists('archive'))) {
  message("Directory `csv` does not exist. Creating.")
  dir.create('archive')  
  }
  copy_to_archive(".", "state-of-repo.html")
}
```

## Community

The Databrary community consists of Institutions and their Authorized Investigators. Authorized Investigators may, in turn, grant access to Affiliates whose access they supervise.

### Growth

```{r user-growth, child = 'rmd/users.Rmd'}
```

### Map

```{r}
# Load saved file
inst_df <- readr::read_csv("csv/institutions.csv", show_col_types = FALSE)
```

```{r site-map, fig.align='center', out.width='80%'}
ggmap::qmplot(lon, lat, 
              data = inst_df, 
              geom = "point")
```

### Investigators by institution

```{r}
with_ais <- inst_df %>%
  dplyr::filter(., n_auth_invest > 0)

ggplot(with_ais) +
  aes(n_auth_invest) +
  geom_histogram()
```

```{r}
gte5_ais <- with_ais %>%
  dplyr::filter(., n_auth_invest >= 5) %>%
  dplyr::mutate(., db_url = paste0("https://nyu.databrary.org/party/", inst_id)) %>%
  dplyr::distinct(.)
```

### Institutions with >= 5 investigators

There are $n=$ `r dim(gte5_ais)[1]` institutions with at least five Authorized (PI-level) Investigators.
They are as follows:

```{r}
gte5_ais %>%
  dplyr::arrange(., desc(n_auth_invest)) %>%
  dplyr::select(., inst_id, inst_name, db_url, n_auth_invest) %>%
  dplyr::distinct(.) %>%
  kableExtra::kbl(.) %>%
  kableExtra::kable_styling(.) %>%
  kableExtra::scroll_box(., height = "400px")
```

### Investigators with >= 5 affiliates

```{r}
invest_df <- readr::read_csv("csv/investigators.csv",
                      show_col_types = FALSE)

gte5_affils <- invest_df %>%
  dplyr::arrange(., ai_id, ai_last) %>%
  dplyr::filter(., n_affils >= 5)
```

In turn, there are $n=$ `r dim(gte5_affils)[1]` Authorized Investigators with 5 or more affiliates (staff, students, postdocs, or other collaborators) who the Authorized Investigators supervise.

```{r}
ggplot(gte5_affils) +
  aes(n_affils) +
  geom_histogram(bins = 10)
```

```{r}
gte5_affils %>%
  dplyr::arrange(., desc(n_affils)) %>%
  dplyr::select(., ai_id, ai_last, ai_first, affiliation, ai_db_url, n_affils) %>%
  dplyr::group_by(., ai_id, ai_last) %>%
  dplyr::distinct(.) %>%
  kableExtra::kbl(.) %>%
  kableExtra::kable_styling(.) %>%
  kableExtra::scroll_box(., height = "400px")
```

## Volumes

A dataset or a collection of research materials is stored as a volume on Databrary.

### Growth

```{r child = 'rmd/volumes_growth.Rmd'}
```

### How shared

```{r}
get_volume_name <- function(vol_id) {
  vol_metadata <- databraryapi::list_volume_metadata(vol_id)
  if (!is.null(vol_metadata)) {
    as.character(vol_metadata$name)
  } else {
    NULL
  }
}

vols_sess_data <- readr::read_csv("csv/shared_volumes_sessions.csv", show_col_types = FALSE)

vols_dat <- vols_sess_data %>%
  # change variable names, create full_volume vs. overview_only
  dplyr::group_by(owner_ids.name, owner_ids.id) %>%
  dplyr::rename(investigator = owner_ids.name, party_id = owner_ids.id) %>%
  dplyr::mutate(shared_type = ifelse(sharing_level == "full", "full_volume", "overview_only")) %>%
  dplyr::select(investigator,
                party_id,
                vol_id,
                created_date,
                shared_type,
                n_sessions) %>%
  dplyr::mutate(url = paste0("https://nyu.databrary.org/party/", party_id)) %>%
  dplyr::group_by(investigator, url, shared_type) %>%
  # summarise by total shared volumes by type with session stats
  dplyr::summarise(
    n_vols = n(),
    tot_sess = sum(n_sessions),
    min_n_sess = min(n_sessions),
    max_n_sess = max(n_sessions)
  ) %>%
  dplyr::arrange(shared_type, desc(tot_sess))

unique_vols <- vols_sess_data %>%
  dplyr::rename(., investigator = owner_ids.name, party_id = owner_ids.id) %>%
  dplyr::mutate(.,
                shared_type = ifelse(sharing_level == "full", 
                                     "full_volume", "overview_only")) %>%
  dplyr::mutate(., vol_url = paste0("https://nyu.databrary.org/volume/", vol_id)) %>%
  dplyr::group_by(., vol_id, vol_name, vol_url, created_date, shared_type, n_sessions) %>%
  dplyr::summarise(., n_owners = n())
```

There are $n=$ `r dim(unique_vols)[1]` total shared volumes on Databrary.

#### Full volume

```{r}
unique_vols_full <- unique_vols %>%
  dplyr::filter(., shared_type == "full_volume")
```

Of these, there are $n=$ `r dim(unique_vols_full)[1]` volumes fully shared on Databrary.

```{r}
unique_vols_full %>%
  dplyr::arrange(., desc(n_sessions)) %>%
  knitr::kable(., "html") %>%
  kableExtra::kable_styling(.) %>%
  kableExtra::scroll_box(., height = "400px")
```

#### Overview only

```{r}
unique_vols_overview <- unique_vols %>%
  dplyr::filter(., shared_type == "overview_only")
```

There are $n=$ `r dim(unique_vols_overview)[1]` volume overviews shared on Databrary. 

```{r}
unique_vols_overview %>%
  dplyr::arrange(., desc(n_sessions)) %>%
  knitr::kable(., "html") %>%
  kableExtra::kable_styling(.) %>%
  kableExtra::scroll_box(., height = "400px")
```

### Types of data

Databrary specializes in storing and sharing video and audio recordings, but the system supports the storage of other file types, see <https://nyu.databrary.org/asset/formats>. 

The following summarizes the composition of currently *shared* data:

```{r, eval=FALSE}
#quietly_read_csv <- safely(readr::read_csv)

if (dir.exists('../volume-assets/csv')) {
  csv_fns <- list.files('../volume-assets/csv', '\\.csv', full.names = TRUE)
  assets_df <- purrr::map_df(csv_fns, readr::read_csv, show_col_types = FALSE)
} else {
  stop(paste0('CSV directory not found: ', '../volume-assets/csv'))
}
```

#### Data by volume

There are $n=$ `r length(unique(assets_df$vol_id))` shared volumes with data/assets.

The following shows the number of shared volumes with a given data/asset type.

```{r, eval=FALSE}
assets_df %>%
  dplyr::group_by(asset_type) %>%
  dplyr::count(asset_type) %>%
  dplyr::arrange(., desc(n)) %>%
  kableExtra::kable(., format = 'html') %>%
  kableExtra::kable_styling(.) %>%
  kableExtra::scroll_box(., height = "400px")
```

#### File-type focus

Here is a summary of the number of files by file type, size (in MB), and where applicable, duration (in hrs).

```{r, eval=FALSE}
assets_df %>%
  dplyr::group_by(asset_type) %>%
  dplyr::summarise(total_files = sum(n_files),
            total_size = sum(tot_size_gb),
            total_dur = sum(tot_dur_hrs)) %>%
  dplyr::arrange(., desc(total_files)) %>%
  dplyr::select(asset_type, total_files, total_size, total_dur) %>%
  kableExtra::kable(., format = 'html') %>%
  kableExtra::kable_styling(.) %>%
  kableExtra::scroll_box(., height = "400px")
```

### Participant demographics

Databrary encourages users doing research with human participants to report demographic data in a structured format so that others may more easily find and reuse data relevant to their questions.

```{r load-demog-csvs, eval=FALSE}
load_demog_csvs <- function(dir = "../participant-demographics/csv") {
  if (!is.character(dir)) {
    stop("'dir' must be a string")
  }
  if (!dir.exists(dir)) {
    stop("'dir' does not exist.")
  }
  
  fl <- list.files(dir, "[0-9]{4}-sess-materials\\.csv$", full.names = TRUE)
  if (is.null(fl)) {
    stop(paste0("No csv files in ", dir, "."))
  }
  purrr::map_dfr(fl, read.csv, colClasses = "character")
}

demo_df <- load_demog_csvs()
```

#### Overall

```{r, eval=FALSE}
demo_df <- demo_df %>%
  dplyr::filter(., session_date != "materials")
```

Databrary has demographic data for at least $n=$ `r sum(!is.na(demo_df$session_id))` individual participant sessions.

Not every volume reports the same collection of demographic variables, so the numbers will vary by variable.

```{r, eval=FALSE}
demo_df <- demo_df %>%
  dplyr::mutate(., vol_url = paste0("https://nyu.databrary.org/volume/", vol_id))
```

#### Gender

The largest number of volumes report gender.

##### Volumes and sessions

```{r gender-volumes, eval=FALSE}
gender_df <- demo_df %>%
  dplyr::filter(., !is.na(participant_gender)) %>%
  dplyr::group_by(., vol_id, vol_url) %>%
  dplyr::summarize(., n_sessions = n()) %>%
  dplyr::ungroup(.) %>%
  dplyr::mutate(., n_vols_w_demo = n())

gender_df %>%
  dplyr::select(., vol_id, vol_url, n_sessions) %>%
  dplyr::arrange(., desc(n_sessions)) %>%
  knitr::kable(., "html") %>%
  kableExtra::kable_styling(.) %>%
  kableExtra::scroll_box(., height = "400px")
```

There are $n=$ `r unique(gender_df$n_vols_w_demo)` volumes reporting `participant.gender`.

##### Number of participants

```{r gender-table, eval=FALSE}
xtabs(formula = ~ participant_gender, data = demo_df) %>%
  knitr::kable(., "html") %>%
  kableExtra::kable_styling(.) %>%
  kableExtra::scroll_box(., height = "400px")
```

#### Race

##### Volumes and sessions

```{r race-volumes, eval=FALSE}
race_df <- demo_df %>%
  dplyr::filter(., !is.na(participant_race)) %>%
  dplyr::group_by(., vol_id, vol_url) %>%
  dplyr::summarize(., n_sessions = n()) %>%
  dplyr::ungroup(.) %>%
  dplyr::mutate(., n_vols_w_demo = n())
```

There are $n=$ `r unique(race_df$n_vols_w_demo)` volumes reporting `participant_race`.

```{r, eval=FALSE}
race_df %>%
  dplyr::select(., vol_id, vol_url, n_sessions) %>%
  dplyr::arrange(., desc(n_sessions)) %>%
  knitr::kable(., "html") %>%
  kableExtra::kable_styling(.) %>%
  kableExtra::scroll_box(., height = "400px")
```

##### Number of participants

```{r race-table, eval=FALSE}
xtabs(formula = ~ participant_race, data = demo_df) %>%
  knitr::kable(., "html") %>%
  kableExtra::kable_styling(.) %>%
  kableExtra::scroll_box(., height = "400px")
```

#### Ethnicity

##### Volumes and sessions

```{r ethnicity-volumes, eval=FALSE}
ethnicity_df <- demo_df %>%
  dplyr::filter(., !is.na(participant_ethnicity)) %>%
  dplyr::group_by(., vol_id, vol_url) %>%
  dplyr::summarize(., n_sessions = n()) %>%
  dplyr::ungroup(.) %>%
  dplyr::mutate(., n_vols_w_demo = n())
```


```{r, eval=FALSE}
ethnicity_df %>%
  dplyr::select(., vol_id, vol_url, n_sessions) %>%
  dplyr::arrange(., desc(n_sessions)) %>%
  knitr::kable(., "html") %>%
  kableExtra::kable_styling(.) %>%
  kableExtra::scroll_box(., height = "400px")
```

There are $n=$ `r unique(ethnicity_df$n_vols_w_demo)` volumes reporting `participant_ethnicity`.

##### Number of participants

```{r ethnicity-table, eval=FALSE}
xtabs(formula = ~ participant_ethnicity, data = demo_df) %>%
  # dplyr::arrange(., desc(Freq)) %>%
  knitr::kable(., "html") %>%
  kableExtra::kable_styling(.) %>%
  kableExtra::scroll_box(., height = "400px")
```

### Tags & keywords

```{r}
tags <- readr::read_csv("../tags-keywords/csv/databrary-tags.csv", show_col_types = FALSE)
```

#### Histogram of tags/volume

```{r tag-stats}
vols_without_tags <- tags %>%
  dplyr::filter(., is.na(tags))

vols_with_tags <- tags %>%
  dplyr::filter(., !is.na(tags)) %>%
  dplyr::group_by(., vol_id) %>%
  dplyr::summarise(., n_tags = n())
```

```{r tags-per-volume-histogram}
vols_with_tags %>%
  ggplot2::ggplot(.) +
  aes(n_tags) +
  geom_histogram(bins = 12)
```

#### Unique tags

```{r unique-tags}
unique_tags <- tags %>%
  dplyr::select(., tags, weight) %>%
  dplyr::filter(., !is.na(tags)) %>%
  dplyr::group_by(., tags) %>%
  dplyr::summarise(., n_vols_using = n(), weight_sum = sum(weight)) %>%
  dplyr::arrange(., desc(n_vols_using))
```

There are $n=$ `r dim(unique_tags)[1]` unique tags.

```{r unique-tags-table}
unique_tags %>%
  knitr::kable(., "html") %>%
  kableExtra::kable_styling()
```

#### Word cloud

```{r word-cloud}
wordcloud::wordcloud(words = unique_tags$tags, 
                     freq = unique_tags$n_vols_using)
```

## Citations

We mine the Google Scholar database to estimate the number of citations to Databrary or Datavyu.

```{r child = 'rmd/citations.Rmd'}
```
