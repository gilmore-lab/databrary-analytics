---
title: "Databrary Usage by NIH grantees"
author: "Rick Gilmore"
date: "`r Sys.Date()`"
output: html_document
params:
  db_login: email@domain.com
  funders_fpath: 'csv/funders.csv'
---

# Purpose

This document describes the current use of Databrary, focusing on projects that are shared at the full or overview only level and which list an NIH funder.

# Preparation

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse) # for pipe %>%
```

# Gather

This report uses data generated by `funders/funder-report.Rmd` and stored in `funders/csv/funders.csv`.

```{r}
funders <- readr::read_csv(params$funders_fpath, show_col_types = FALSE)

if (dim(funders)[1] == 0) stop(paste0('Empty file: ', params$funders_fpath))
```

# Clean

```{r}
funders_clean <- funders %>%
  dplyr::filter(., !is.na(vol_id), !is.na(funder_id), !is.na(funder_name))
```

There are $n=$ `r length(unique(funders_clean$vol_id))` shared *volumes* that report funding information, and $n=$ `r length(unique(funders$funder_name))` unique funders.

```{r}
funders_nih <- funders_clean %>%
  dplyr::filter(., stringr::str_detect(funder_name, 'National Institute'))

funders_nih
```

Filtering those which represent NIH entities, there are There are $n=$ `r length(unique(funders_nih$vol_id))` shared *volumes* that report funding information from NIH, and $n=$ `r length(unique(funders_nih$funder_name))` unique sources:

```{r}
funders_nih %>%
  dplyr::group_by(., funder_name) %>%
  dplyr::summarise(., n_volumes = n()) %>%
  dplyr::arrange(., desc(n_volumes)) %>%
  kableExtra::kable()
```

Let's look at the volumes that list NIH to see if we can determine the institute from the `award` field.

```{r}
funders_nih %>%
  dplyr::filter(., stringr::str_detect(funder_name, 'National Institutes of Health \\(NIH\\)')) %>%
  dplyr::select(., -funder_id) %>%
  kableExtra::kable()
```

For the most part, we can determine the institute from the `award` field. We'll add an `institute` field derived from the award and try to clean things up that way.

```{r}
contains_hd <- stringr::str_detect(funders_nih$award, '[hH]{1}[dD]{1}') |
  stringr::str_detect(funders_nih$funder_name, 'NICHD')
contains_mh <- stringr::str_detect(funders_nih$award, '[mM]{1}[hH]{1}') |
  stringr::str_detect(funders_nih$funder_name, 'NIMH')
contains_ey <- stringr::str_detect(funders_nih$award, '[eE]{1}[yY]{1}') |
  stringr::str_detect(funders_nih$funder_name, 'NEI')
contains_od <- stringr::str_detect(funders_nih$award, '[oO]{1}[dD]{1}')
#contains_aa <- stringr::str_detect(funders_nih$funder_name, '[aA]{1}[aA]{1}')
  
funders_nih <- funders_nih %>%
  dplyr::mutate(., institute = funder_name)

funders_nih$institute[contains_hd] <- 'National Institute of Child Health and Human Development (NICHD)'
funders_nih$institute[contains_mh] <- 'National Institute of Mental Health (NIMH)'
funders_nih$institute[contains_ey] <- 'National Eye Institute (NEI)'
funders_nih$institute[contains_od] <- 'National Institutes of Health, Office of the Director (OD)'
#funders_nih$institute[contains_aa] <- 'National Institute on Again (NIA'

funders_nih %>%
  dplyr::group_by(., institute) %>%
  dplyr::summarise(., n_volumes = n()) %>%
  dplyr::arrange(., desc(n_volumes)) %>%
  dplyr::distinct(.) %>%
  kableExtra::kable()
```
The specific projects/volumes and awards that list NIMH as a funder include:

```{r}
funders_nih %>%
  dplyr::filter(., institute == 'National Institute of Mental Health (NIMH)') %>%
  dplyr::mutate(., url = paste0("https://nyu.databrary.org/volume/", vol_id)) %>%
  dplyr::arrange(., vol_id) %>%
  dplyr::select(., -c(funder_id, funder_name)) %>%
  dplyr::select(., vol_id, url, institute, award) %>%
  #dplyr::distinct(.) %>% # remove duplicate rows
  kableExtra::kable(.)
```

# Looking at "hidden" volumes

```{r}
all_vols <- readr::read_csv("csv/databrary-volume-survey-2022-08-24.csv", show_col_types = FALSE)

vols_nonblank <- all_vols %>%
  dplyr::filter(., !stringr::str_detect(sharing_level, "404"),
                !is.na(sharing_level),
                !is.na(funding_listed))
```

Volumes by sharing type:

```{r}
vols_nonblank %>%
  dplyr::group_by(sharing_level) %>%
  dplyr::summarise(n_vols = n()) %>%
  dplyr::select(., sharing_level, n_vols) %>%
  kableExtra::kable(.)
```

List funding by sharing type:

```{r}
xtabs(formula = ~ sharing_level + funding_listed, data = vols_nonblank)
```

Number of files by sharing type:

```{r}
vols_nonblank %>%
  dplyr::filter(., !is.na(n_files)) %>%
  dplyr::mutate(., n_files_i = strtoi(n_files)) %>%
  dplyr::group_by(sharing_level) %>%
  dplyr::summarise(., n_tot_files = sum(n_files_i)) %>%
  kableExtra::kable(.)
```


Select private volumes with `funding_listed == TRUE`

```{r}
private_list_funding <- vols_nonblank %>%
  dplyr::filter(., funding_listed == 'yes', sharing_level == 'private')
```

```{r, message=FALSE}
# wrapper function so we get information at the console
get_volume_funding <- function(vol_id) {
  message('Getting funders for volume ', vol_id)
  databraryapi::list_volume_funding(vol_id)
}

private_vol_ids <- unique(private_list_funding$volume_id)

private_funders_df <- purrr::map_df(private_vol_ids, get_volume_funding)
```

