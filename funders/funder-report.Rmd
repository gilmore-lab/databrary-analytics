---
title: "Funders"
output: 
  html_document:
    self_contained: True
    toc: True
    toc_float: True
    toc_depth: 2
    code_folding: show
params:
  max_vol_id: 1300
  use_saved_file: False
  save_fn: "csv/funders.csv"
  save_file: True
  db_login: email@provider.com
---

# Purpose

This document describes generates a list of funders on Databrary projects.

In typical use, run the following command from the repo's root directory:

```
rmarkdown::render("funders/funder-report.Rmd", params = list(use_saved_file = "True", db_login="<YOURDBEMAIL@INST.EDU>"))
```

# Preparation

```{r set-up, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
```

# Gather data

There is no easy way to determine the largest volume ID to query via the API, so this tests various values that are higher than the last one used as specified in `params$use_saved_file`.

```{r get-funder-data}
# max_vol_id <- 1180
# funders_df <- purrr::map_df(1:1180, databraryapi::list_volume_funding)
if (params$use_saved_file) {
  if (file.exists(params$save_fn)) {
    message("Reading from saved file.")
    funders_df <- read_csv(params$save_fn)
    # From current max(vol_id), get next 200 vols
    # max_vol_id <- max(vols_funder_data$vol_id)
    # next_200 <- purrr::map_df(max_vol_id + 1:max_vol_id + 200, databraryapi::list_volume_funding)
    # funders_df <- data.table::rbindlist(list(vols_funder_data, next_200))
  } else {
    message("File not found.")
    message(" Regenerating data from all volumes.")
    funders_df <- purrr::map_df(1:params$max_vol_id, databraryapi::list_volume_funding)
  }
} else {
  message(" Regenerating data from all volumes.")
  funders_df <- purrr::map_df(1:params$max_vol_id, databraryapi::list_volume_funding)
}
```

```{r save-data}
if (params$save_file) {
  message(paste0("Saving file: ", params$save_fn))
  readr::write_csv(funders_df, file = params$save_fn)
}
```

## Volumes by funder

```{r filter-print}
funders_filtered <- funders_df %>%
  dplyr::filter(., !is.na(funder_id), !is.na(funder_name)) %>%
  dplyr::group_by(., funder_name) %>%
  dplyr::summarize(., n_vols = n()) %>%
  dplyr::arrange(., desc(n_vols))

funders_filtered %>%
  kableExtra::kable(.) %>%
  kableExtra::kable_styling(.)
```

## Logout

```{r logout}
databraryapi::logout_db()
if (file.exists(".databrary.RData")) {
  unlink(".databrary.RData")
}
```