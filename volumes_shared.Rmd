---
title: "volumes-shared"
author: "Andrea Seisler"
# date:  "`r Sys.time()`"
# 
# # Appends the date to the output filename
# knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = paste0(substr(inputFile,1,nchar(inputFile)-4),'_',Sys.Date(),'.html')) })
# 
# # How do we move the folder with the files for this?
# 
# output:
#   html_document:
#     code_folding: hide
#     number_sections: yes
#     self_contained: no
#     toc: yes
#     toc_depth: 3
#     toc_float: yes
# params:
#   db_account: rogilmore@psu.edu
#   update_gs: no
#   update_stats: yes
#   vols_to_test: 10
---




<!-- # Volumes -->

```{r data-from-googlesheets}
#key <- "1tvlIQzULrMtXo97aJu71ljdTmNXkwwpU9eOOasVer3g"
db <- gs_title('Databrary-analytics')
```

<!-- Let's try a new workflow based on Google Sheets. -->
<!-- We should already have the spreadsheet loaded. -->

```{r load-vols-from-googlesheets}
old_vols <- db %>%
  gs_read(ws = 'volumes-shared-unshared')
```
Now update from information derived from `databraryapi::db_stats()` if `params$update_stats` is TRUE.

```{r update-volumes-data}
updated_vols <- old_vols
if (as.logical(params$update_stats)) {
  next_entry <- dim(updated_vols)[1] + 1
  updated_vols[next_entry,] = NA
  
  updated_vols$date[next_entry] <- new_stats$date
  if (is.null(new_stats$datasets_shared)) {
    new_stats$datasets_shared = 0
  }
  updated_vols$shared_volumes[next_entry] <- new_stats$datasets_shared
  updated_vols$unshared_volumes[next_entry] <- 
    new_stats$datasets_total - new_stats$datasets_shared
}
updated_vols <- updated_vols %>%
  gather(., key = "type", value = "count", -date)
```

```{r db-vols-plot}
# Plot
vols_plot <- updated_vols %>%
  ggplot(., aes(x = date, y = count, color = type, group = type)) +
  geom_point() + 
  geom_line(size=ln_size) +
  scale_colour_manual(values=c(color_orange, color_teal)) +
  ggtitle(paste("Databrary Volumes as of ", Sys.Date())) +
  ylab("Volumes") +
  databrary_theme +
  scale_y_continuous(breaks = seq(0, round_any(max(updated_vols$count), 100, ceiling), 100), expand = c(0,0)) +
  coord_cartesian(ylim = c(0, round_any(max(updated_vols$count), 100, ceiling)))


ggdraw(vols_plot) + 
  draw_label("Unshared, ", colour = color_teal, .79, .85) +
  draw_label(max(new_stats$datasets_total - new_stats$datasets_shared), colour = color_teal, .88, .85) +
  draw_label("Shared, ", colour = color_orange, .74, .65) +
  draw_label(max(new_stats$datasets_shared), colour = color_orange, .81, .65)
```

<!-- ## New volumes -->

```{r new-volumes}
# define helper functions
new_volumes <- databraryapi::get_db_stats(type = "datasets")
if (is.null(new_volumes)) {
  stop('New volumes data not downloaded.')
}

unnested_vols <- new_volumes %>%
  unnest(.)
  # rename(., owner_name = name1, owner_id = id1) %>%

unnested_vols$owner_name <- unnested_vols$name1
unnested_vols$owner_id = unnested_vols$name1

unnested_vols <- unnested_vols %>%
  mutate(., url = paste0("https://nyu.databrary.org/volume/", id),
         date_created = lubridate::as_date(creation))
  
unnested_vols %>%
  select(., name, date_created, owner_name, url) %>%
  knitr::kable(col.names = c("Volume Name", "Date Created", "Owner Name", "Databrary URL"))%>%
  kable_styling()
```